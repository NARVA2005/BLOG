<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: entradas.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: entradas.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Entradas } from "../models/entradas.js";
import multer from "multer";
import fs from "fs";
import eliminarFile from "../models/configuracionFile.js";



/**
 * Configuración de `multer` para manejar cargas de imágenes.
 * 
 * El almacenamiento se configura para almacenar las imágenes en una carpeta específica
 * y generar nombres de archivos únicos basados en la fecha y el nombre original del archivo.
 * 
 * @constant
 * @type {multer.StorageEngine}
 */

const storage = multer.diskStorage({
      /**
     * Establece el destino donde se almacenarán los archivos.
     * 
     * @function
     * @param {Object} req - Objeto de solicitud HTTP.
     * @param {Object} file - Objeto de archivo que contiene información sobre el archivo cargado.
     * @param {function} cb - Callback para indicar la finalización de la configuración del destino.
     */
    destination: (req, file, cb) => {
        const path = './upload/Publicacion/';
        fs.mkdirSync(path, { recursive: true });
        cb(null, path);
    },
      /**
     * Genera un nombre de archivo único basado en la fecha y el nombre original del archivo.
     * 
     * @function
     * @param {Object} req - Objeto de solicitud HTTP.
     * @param {Object} file - Objeto de archivo que contiene información sobre el archivo cargado.
     * @param {function} cb - Callback para indicar la finalización de la configuración del nombre del archivo.
     */ 
    filename: (req, file, cb) => {
    
        cb(null, Date.now() + '-' + file.originalname);
    }
});
/**
 * Configuración de `multer` para manejar un solo archivo de imagen.
 * 
 * @constant
 * @type {multer.Instance}
 */
const upload = multer({ storage: storage }).single('imagen'); //Un solo archivo


/**
 * Crea una nueva entrada o publicación.
 * 
 * @async
 * @function crearPublicacion
 * @param {Object} req - Objeto de solicitud HTTP.
 * @param {Object} res - Objeto de respuesta HTTP.
 * @returns {Promise&lt;void>} - Retorna una respuesta HTTP con el estado de la creación de la publicación.
 * 
 * @throws {Error} Si ocurre un error durante la carga del archivo o la creación de la publicación.
 */

export const crearPublicacion = async (req, res) => {
    upload(req, res, async (err) => {
        //Verificar que no hayan errores de multer en el sistema            
        if (err instanceof multer.MulterError) {
            console.error('Multer error:', err);
            return res.status(500).json({ message: 'Error al subir el archivo.', error: err.message });
        } else if (err) {
            console.error('Error:', err);
            return res.status(500).json({ message: 'Error del servidor.', error: err.message });
        }

        try {
            // Validar y asignar el archivo
            if (req.file) {
                //Condicion para verificar que los archivos ingresados si sean los correctos en la base de datos del sistema
                const condicion = req.file.mimetype !== "image/png" &amp;&amp; req.file.mimetype !== "image/jpeg";
                if (condicion) {
                    res.status(400).send({
                        message: ["El archivo ingresado no es el correcto (.png, .jpg o .jpeg)"],
                    });
                    //Se localiza el archivo y lo eliminamos
                 eliminarFile(req.file.filename, "Publicacion"); 
                    return;
                }
                req.body.imagen = req.file.filename;
            } else {
              delete req.body.imagen;
            }

            const { Titulos, Contenido, fechaPublicacion} = req.body;
            console.log(Titulos, Contenido, fechaPublicacion); 

            if (!Titulos || !Contenido || !fechaPublicacion) {
                res.status(400).send({
                    message: "Todos los campos son obligatorios",
                });
                if (req.file) {
                    eliminarFile(req.file.filename, "Publicacion");
                }
                return;
            }

            const nuevaPublicacion = await Entradas.create({
                Titulos,
                Contenido,
                fechaPublicacion,
                imagen: req.body.imagen,
    
            });

            // Devolver la publicación
        // Devolver la publicación
      res.status(200).json({ message: "Publicación creada correctamente", data: nuevaPublicacion });
        } catch (error) {
            if (req.file) {
                eliminarFile(req.file.filename, "Publicacion");
            }
            console.error('Error al crear la publicación:', error);
            if (error.name === "SequelizeValidationError") {
                const validationErrors = error.errors.map((err) => err.message);
                res.status(400).json({ message: validationErrors });
            } else {
                res.status(500).json({ message: [error.message] });
            }
        }
    });
};



/**
 * Edita una publicación existente.
 * 
 * @async
 * @function editarPublicacion
 * @param {Object} req - Objeto de solicitud HTTP.
 * @param {Object} req.params - Parámetros de la solicitud.
 * @param {string} req.params.idEntradas - ID de la entrada a editar.
 * @param {Object} req.body - Cuerpo de la solicitud HTTP.
 * @param {string} req.body.Titulos - Título de la publicación.
 * @param {string} req.body.Contenido - Contenido de la publicación.
 * @param {string} req.body.fechaPublicacion - Fecha de la publicación.
 * @param {Object} res - Objeto de respuesta HTTP.
 * @returns {Promise&lt;void>} - Retorna una respuesta HTTP con el estado de la edición de la publicación.
 * 
 * @throws {Error} Si ocurre un error durante la carga del archivo o la edición de la publicación.
 */

export const editarPublicacion = async (req, res) => {
    const { idEntradas } = req.params;
    upload(req, res, async (err) => {
        //Verificar que no hayan errores de multer en el sistema            
        if (err instanceof multer.MulterError) {
            console.error('Multer error:', err);
            return res.status(500).json({ message: 'Error al subir el archivo.', error: err.message });
        } else if (err) {
            console.error('Error:', err);
            return res.status(500).json({ message: 'Error del servidor.', error: err.message });
        }

        try {
            if (req.file) {
                const condicion = req.file.mimetype !== "image/png" &amp;&amp; req.file.mimetype !== "image/jpeg";
                if (condicion) {
                    res.status(400).send({ message: ["El archivo ingresado no es el correcto (.png, .jpg o .jpeg)"] });
                    eliminarFile(req.file.filename, "Publicacion");
                    return;
                }
                req.body.imagen = req.file.filename;
            } else {
                req.body.imagen = "";
            }

            const { Titulos, Contenido, fechaPublicacion } = req.body;
         

            if (!Titulos || !Contenido || !fechaPublicacion) {
                res.status(400).send({ message: "Todos los campos son obligatorios" });
                if (req.file) {
                    eliminarFile(req.file.filename, "Publicacion");
                }
                return;
            }

            const actualizar = await Entradas.update({
                Titulos,
                Contenido,
                fechaPublicacion,
                imagen: req.body.imagen,
            }, {
                where: { idEntradas: idEntradas }
            });

            res.status(200).json({ message: "Publicación actualizada correctamente", data: actualizar });
        } catch (error) {
            if (req.file) {
                eliminarFile(req.file.filename, "Publicacion");
            }
            console.error('Error al actualizar la publicación:', error);
            if (error.name === "SequelizeValidationError") {
                const validationErrors = error.errors.map((err) => err.message);
                res.status(400).json({ message: validationErrors });
            } else {
                res.status(500).json({ message: [error.message] });
            }
        }
    });
};

/**
 * Desactiva una publicación existente.
 * 
 * @async
 * @function desactivarPublicacion
 * @param {Object} req - Objeto de solicitud HTTP.
 * @param {Object} req.params - Parámetros de la solicitud.
 * @param {string} req.params.idEntradas - ID de la entrada a desactivar.
 * @param {Object} req.body - Cuerpo de la solicitud HTTP.
 * @param {boolean} req.body.estado - Nuevo estado de la publicación.
 * @param {Object} res - Objeto de respuesta HTTP.
 * @returns {Promise&lt;void>} - Retorna una respuesta HTTP con el estado de la desactivación de la publicación.
 * 
 * @throws {Error} Si ocurre un error durante la desactivación de la publicación.
 */

export const desactivarPublicacion= async(req, res)=>{
    try {
        const{idEntradas}=req.params;
        const{estado}=req.body;
    
        const [entradaDesabilitar] = await Entradas.update(
            {
            estado:estado
        },{     
            where:
            {idEntradas:idEntradas}
        });
        if(entradaDesabilitar){
    res.status(200).json({message: "Publicacion o entrada eliminada"});
        }else{
            res.status(401).json({message:"Publicacion no eliminada"});
        }
    } catch (error) {
        console.log(error,"publicacion no modificado, por el servidor");
    }
  
}

/**
 * Trae todas las publicaciones activas de la base de datos.
 * 
 * @async
 * @function TraerTodasEntradas
 * @param {Object} req - Objeto de solicitud HTTP.
 * @param {Object} res - Objeto de respuesta HTTP.
 * @returns {Promise&lt;void>} - Retorna una respuesta HTTP con todas las publicaciones activas encontradas o un mensaje de error.
 * 
 * @throws {Error} Si ocurre un error al obtener las publicaciones de la base de datos.
 */

export const TraerTodasEntradas=async(req, res)=>{
try {
 
    const TraerTodos=await Entradas.findAll({
where:{
    estado:'activo'
}
    })
/* console.log(TraerTodos); */

if(TraerTodos.length>0){
    res.status(200).json(TraerTodos);
}else{
res.status(400).json({message:"No se encontraron comentarios datos"});
}
} catch (error) {
    console.log(error, "Error al traer todas las publicaciones")
}
}

/**
 * Trae todas las publicaciones con un ID específico.
 * 
 * @async
 * @function TraerTodasID
 * @param {Object} req - Objeto de solicitud HTTP.
 * @param {Object} req.params - Parámetros de la solicitud.
 * @param {string} req.params.idEntradas - ID de la entrada a buscar.
 * @param {Object} res - Objeto de respuesta HTTP.
 * @returns {Promise&lt;void>} - Retorna una respuesta HTTP con las publicaciones encontradas o un mensaje de error.
 * 
 * @throws {Error} Si ocurre un error al obtener las publicaciones de la base de datos.
 */

export const TraerTodasID=async(req, res)=>{
    try {
        const{idEntradas}=req.params;
     
        const TraerTodosid=await Entradas.findAll({
    where:{
        idEntradas:idEntradas
    }
        })
        if(TraerTodosid.length>0){
            res.status(200).json(TraerTodosid);
        }else{
            res.status(200).json({message:"No hay comentarios con ese id"});
        }
    /* console.log(TraerTodos); */
 
    
    } catch (error) {
        console.log(error, "Error al traer todas las publicaciones")
    }
    }</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#EliminarComentario">EliminarComentario</a></li><li><a href="global.html#TraerTodasEntradas">TraerTodasEntradas</a></li><li><a href="global.html#TraerTodasID">TraerTodasID</a></li><li><a href="global.html#TraerUsuarioID">TraerUsuarioID</a></li><li><a href="global.html#TraerUsuarios">TraerUsuarios</a></li><li><a href="global.html#crearComentario">crearComentario</a></li><li><a href="global.html#crearPublicacion">crearPublicacion</a></li><li><a href="global.html#crearUsuario">crearUsuario</a></li><li><a href="global.html#desactivarPublicacion">desactivarPublicacion</a></li><li><a href="global.html#desactivarUsuario">desactivarUsuario</a></li><li><a href="global.html#destination">destination</a></li><li><a href="global.html#editarComentario">editarComentario</a></li><li><a href="global.html#editarPublicacion">editarPublicacion</a></li><li><a href="global.html#editarUsuario">editarUsuario</a></li><li><a href="global.html#filename">filename</a></li><li><a href="global.html#storage">storage</a></li><li><a href="global.html#traerTodosComentario">traerTodosComentario</a></li><li><a href="global.html#upload">upload</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.3</a> on Tue Jul 09 2024 07:21:00 GMT-0500 (hora estándar de Colombia)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
